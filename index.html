<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Math Drop Game</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
      background: linear-gradient(135deg, #FFB347 0%, #FF6B9D 100%);
      overflow: hidden;
      height: 100vh;
      -webkit-user-select: none;
      user-select: none;
    }
    
    .screen { display: none; }
    .screen.active { display: block; width: 100vw; height: 100vh; }
    
    .home-screen, .difficulty-screen { 
      padding: 20px; 
      display: none;
      flex-direction: column; 
      align-items: center; 
      justify-content: flex-start;
      overflow-y: auto;
    }
    
    .home-screen.active, .difficulty-screen.active { display: flex; }
    
    h1 { color: white; font-size: 36px; margin-bottom: 20px; text-align: center; }
    .subtitle { color: white; font-size: 20px; margin-bottom: 30px; text-align: center; font-weight: bold; }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      max-width: 400px;
      width: 100%;
    }
    
    .card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .card h2 {
      font-size: 20px;
      color: #2D3748;
      margin-bottom: 15px;
      text-align: center;
    }
    
    button {
      width: 100%;
      padding: 15px;
      margin: 8px 0;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      background: linear-gradient(145deg, #4ECDC4, #45B7D1);
      color: white;
      cursor: pointer;
      font-family: inherit;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    .diff-easy { background: linear-gradient(145deg, #06D6A0, #05C494); }
    .diff-medium { background: linear-gradient(145deg, #FFE66D, #FFD93D); color: #2D3748; }
    .diff-hard { background: linear-gradient(145deg, #EF476F, #E63E6D); }
    
    .back-btn {
      background: linear-gradient(145deg, #AA96DA, #9B7EDE);
      max-width: 200px;
      margin-top: 20px;
    }
    
    .game-screen {
      position: relative;
      background: linear-gradient(135deg, #FFE5B4 0%, #E0BBE4 100%);
      padding-bottom: 200px;
    }
    
    .ui {
      position: fixed;
      top: 0;
      left: 0;
      right: 50%;
      background: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 3px solid #4ECDC4;
      z-index: 100;
    }
    
    .score { font-size: 24px; font-weight: bold; color: #EF476F; }
    .lives { font-size: 24px; }
    .timer { 
      font-size: 28px; 
      font-weight: bold; 
      color: #06D6A0;
      background: #F7FAFC;
      padding: 5px 15px;
      border-radius: 10px;
      border: 2px solid #4ECDC4;
    }
    .timer.warning { color: #EF476F; }
    
    .problem {
      position: fixed;
      left: 15%;
      transform: translateX(-50%);
      background: white;
      padding: 20px;
      border-radius: 15px;
      border: 4px solid #4ECDC4;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      z-index: 50;
      min-width: 200px;
      max-width: 40vw;
      transition: top 0.05s linear;
    }
    
    .problem .question {
      font-size: 28px;
      font-weight: bold;
      color: #2D3748;
      text-align: center;
      margin-bottom: 10px;
    }
    
    .problem .answer {
      background: #F7FAFC;
      border: 3px solid #4ECDC4;
      border-radius: 10px;
      padding: 8px;
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      min-height: 40px;
      line-height: 40px;
      color: #2D3748;
    }
    
    .numpad {
      position: fixed;
      top: 80px;
      right: 0;
      bottom: 0;
      width: 50%;
      background: white;
      padding: 15px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 10px;
      border-left: 3px solid #4ECDC4;
      z-index: 101;
    }
    
    .numpad button {
      padding: 15px;
      margin: 0;
      font-size: 24px;
      border-radius: 12px;
      height: 100%;
    }
    
    .numpad .zero { grid-column: span 2; }
    .numpad .clear { 
      grid-column: span 3; 
      background: linear-gradient(145deg, #F38181, #E76B6B);
    }
    
    .game-over, .leaderboard-screen {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      overflow-y: auto;
    }
    
    .game-over.active, .leaderboard-screen.active { display: flex; }
    
    .game-over-content, .leaderboard-content {
      background: linear-gradient(145deg, #FFB347, #FF6B9D);
      color: white;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      max-width: 90vw;
      border: 4px solid white;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .game-over h2, .leaderboard-content h2 { font-size: 36px; margin-bottom: 20px; }
    .game-over p { font-size: 24px; margin: 10px 0; }
    
    .game-over button, .leaderboard-content button {
      margin: 10px 5px;
      background: linear-gradient(145deg, #06D6A0, #05C494);
    }
    
    .lb-table {
      background: white;
      color: #2D3748;
      border-radius: 12px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    .lb-table table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .lb-table th {
      background: #4ECDC4;
      color: white;
      padding: 12px;
      font-size: 16px;
    }
    
    .lb-table td {
      padding: 10px;
      border-bottom: 1px solid #E2E8F0;
      font-size: 16px;
    }
    
    .lb-table tr:nth-child(even) {
      background: #F7FAFC;
    }
    
    .name-input {
      padding: 12px;
      font-size: 18px;
      border: 2px solid white;
      border-radius: 10px;
      width: 250px;
      margin: 10px 0;
    }
  </style>
</head>
<body>

<div class="screen active home-screen" id="home">
  <h1>üéØ Math Drop! üéØ</h1>
  
  <div class="grid">
    <div class="card">
      <h2>‚ûï Addition</h2>
      <button onclick="selectGame('addition', 20)">Up to 20</button>
      <button onclick="selectGame('addition', 30)">Up to 30</button>
    </div>
    
    <div class="card">
      <h2>‚úñÔ∏è Times Tables</h2>
      <button onclick="selectGame('tables', 2)">2√ó Table</button>
      <button onclick="selectGame('tables', 3)">3√ó Table</button>
      <button onclick="selectGame('tables', 4)">4√ó Table</button>
      <button onclick="selectGame('tables', 5)">5√ó Table</button>
      <button onclick="selectGame('tables', 6)">6√ó Table</button>
      <button onclick="selectGame('tables', 7)">7√ó Table</button>
      <button onclick="selectGame('tables', 8)">8√ó Table</button>
      <button onclick="selectGame('tables', 9)">9√ó Table</button>
      <button onclick="selectGame('tables', 10)">10√ó Table</button>
    </div>
    
    <div class="card">
      <h2>üèÜ Leaderboard</h2>
      <button onclick="showLeaderboard()">View High Scores</button>
    </div>
  </div>
</div>

<div class="screen difficulty-screen" id="difficulty">
  <h1>Choose Difficulty</h1>
  <p class="subtitle" id="game-choice"></p>
  
  <div class="grid">
    <button class="diff-easy" onclick="startGameWithDifficulty('easy')">üòä Easy<br><small>5 Lives ‚Ä¢ Slow</small></button>
    <button class="diff-medium" onclick="startGameWithDifficulty('medium')">üòê Medium<br><small>3 Lives ‚Ä¢ Normal</small></button>
    <button class="diff-hard" onclick="startGameWithDifficulty('hard')">üò§ Hard<br><small>2 Lives ‚Ä¢ Fast</small></button>
    <button class="back-btn" onclick="backToHome()">‚Üê Back</button>
  </div>
</div>

<div class="screen game-screen" id="game">
  <div class="ui">
    <div class="score">Score: <span id="score">0</span></div>
    <div class="timer" id="timer">10</div>
    <div class="lives" id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    <button onclick="goHome()" style="width:auto; padding:10px 15px; margin:0;">üè†</button>
  </div>
  
  <div class="numpad">
    <button onclick="addNum('1')">1</button>
    <button onclick="addNum('2')">2</button>
    <button onclick="addNum('3')">3</button>
    <button onclick="addNum('4')">4</button>
    <button onclick="addNum('5')">5</button>
    <button onclick="addNum('6')">6</button>
    <button onclick="addNum('7')">7</button>
    <button onclick="addNum('8')">8</button>
    <button onclick="addNum('9')">9</button>
    <button class="zero" onclick="addNum('0')">0</button>
    <button class="clear" onclick="clearNum()">Clear</button>
  </div>
</div>

<div class="game-over" id="gameover">
  <div class="game-over-content">
    <h2>Well Done! üéâ</h2>
    <p>Score: <span id="finalscore">0</span>/10</p>
    <p>Time: <span id="finaltime">0</span>s</p>
    <p id="message"></p>
    <div id="name-entry" style="display:none;">
      <p>üèÜ New High Score! Enter your name:</p>
      <input type="text" class="name-input" id="playername" placeholder="Your name" maxlength="15">
    </div>
    <button onclick="saveAndContinue()">Continue</button>
    <button onclick="playAgain()">Play Again</button>
    <button onclick="goHome()">Home</button>
  </div>
</div>

<div class="leaderboard-screen" id="leaderboard">
  <div class="leaderboard-content">
    <h2>üèÜ Leaderboard</h2>
    <div id="lb-content"></div>
    <button onclick="closeLeaderboard()">Close</button>
  </div>
</div>

<script>
console.log('Script loaded!');

var score = 0;
var question = 1;
var lives = 3;
var maxLives = 3;
var gameActive = false;
var currentAnswer = '';
var correctAnswer = 0;
var gameType = '';
var gameLevel = 0;
var difficulty = 'medium';
var problemEl = null;
var problemY = 80;
var fallSpeed = 1.5;
var animationId = null;
var answered = false;
var timeLeft = 10;
var timerInterval = null;
var gameStartTime = 0;
var gameTotalTime = 0;
var audioCtx = null;
var soundEnabled = true;

var difficultySettings = {
  easy: { lives: 5, speed: 1.0, time: 15 },
  medium: { lives: 3, speed: 1.5, time: 10 },
  hard: { lives: 2, speed: 2.5, time: 7 }
};

function initAudio() {
  if (!audioCtx) {
    try {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    } catch(e) {
      console.log('Audio not supported');
      soundEnabled = false;
    }
  }
}

function playSound(freq, duration, type) {
  if (!soundEnabled || !audioCtx) return;
  var osc = audioCtx.createOscillator();
  var gain = audioCtx.createGain();
  osc.frequency.value = freq;
  osc.type = type || 'sine';
  gain.gain.value = 0.1;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  setTimeout(function() { osc.stop(); }, duration);
}

function correctSound() {
  playSound(523, 100, 'sine');
  setTimeout(function() { playSound(659, 100, 'sine'); }, 100);
}

function wrongSound() {
  playSound(200, 150, 'square');
}

function selectGame(type, level) {
  console.log('Game selected:', type, level);
  gameType = type;
  gameLevel = level;
  
  var gameName = '';
  if (type === 'addition') {
    gameName = 'Addition up to ' + level;
  } else {
    gameName = level + '√ó Times Table';
  }
  
  document.getElementById('game-choice').textContent = gameName;
  document.getElementById('home').classList.remove('active');
  document.getElementById('difficulty').classList.add('active');
}

function startGameWithDifficulty(diff) {
  console.log('Starting game with difficulty:', diff);
  difficulty = diff;
  
  var settings = difficultySettings[diff];
  maxLives = settings.lives;
  lives = maxLives;
  fallSpeed = settings.speed;
  timeLeft = settings.time;
  
  score = 0;
  question = 1;
  currentAnswer = '';
  gameActive = true;
  gameStartTime = Date.now();
  
  initAudio();
  
  document.getElementById('difficulty').classList.remove('active');
  document.getElementById('game').classList.add('active');
  document.getElementById('gameover').classList.remove('active');
  
  updateUI();
  nextQuestion();
}

function backToHome() {
  document.getElementById('difficulty').classList.remove('active');
  document.getElementById('home').classList.add('active');
}

function nextQuestion() {
  console.log('nextQuestion called, question:', question, 'lives:', lives);
  
  if (question > 10 || lives <= 0) {
    console.log('Game should end now');
    endGame();
    return;
  }
  
  currentAnswer = '';
  answered = false;
  var prob = makeProblem();
  correctAnswer = prob.answer;
  
  console.log('Problem:', prob.question, 'Answer:', correctAnswer);
  
  if (problemEl) problemEl.remove();
  if (animationId) cancelAnimationFrame(animationId);
  if (timerInterval) clearInterval(timerInterval);
  
  problemEl = document.createElement('div');
  problemEl.className = 'problem';
  problemY = 80;
  problemEl.style.top = problemY + 'px';
  problemEl.innerHTML = '<div class="question">' + prob.question + '</div><div class="answer" id="ans"></div>';
  
  document.getElementById('game').appendChild(problemEl);
  
  timeLeft = difficultySettings[difficulty].time;
  updateTimer();
  startTimer();
  fallProblem();
}

function startTimer() {
  timerInterval = setInterval(function() {
    timeLeft--;
    updateTimer();
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      if (!answered && gameActive) {
        wrongSound();
        lives--;
        updateUI();
        question++;
        setTimeout(nextQuestion, 500);
      }
    }
  }, 1000);
}

function updateTimer() {
  var timerEl = document.getElementById('timer');
  timerEl.textContent = timeLeft;
  if (timeLeft <= 3) {
    timerEl.classList.add('warning');
  } else {
    timerEl.classList.remove('warning');
  }
}

function fallProblem() {
  if (!gameActive || answered) return;
  
  problemY += fallSpeed;
  
  if (problemEl) {
    problemEl.style.top = problemY + 'px';
  }
  
  var bottomLimit = window.innerHeight - 150;
  
  if (problemY >= bottomLimit) {
    console.log('Problem hit bottom!');
    if (timerInterval) clearInterval(timerInterval);
    wrongSound();
    lives--;
    updateUI();
    question++;
    setTimeout(nextQuestion, 500);
    return;
  }
  
  animationId = requestAnimationFrame(fallProblem);
}

function makeProblem() {
  var a, b, ans, q;
  if (gameType === 'addition') {
    a = Math.floor(Math.random() * (gameLevel - 5)) + 1;
    b = Math.floor(Math.random() * (gameLevel - a)) + 1;
    ans = a + b;
    q = a + ' + ' + b + ' = ?';
  } else {
    a = gameLevel;
    b = Math.floor(Math.random() * 12) + 1;
    ans = a * b;
    q = a + ' √ó ' + b + ' = ?';
  }
  return { question: q, answer: ans };
}

function addNum(n) {
  if (!gameActive || answered) return;
  if (currentAnswer.length >= 3) return;
  
  currentAnswer += n;
  document.getElementById('ans').textContent = currentAnswer;
  
  var digits = String(correctAnswer).length;
  if (currentAnswer.length >= digits) {
    setTimeout(checkAnswer, 300);
  }
}

function clearNum() {
  currentAnswer = '';
  if (document.getElementById('ans')) {
    document.getElementById('ans').textContent = '';
  }
}

function checkAnswer() {
  if (answered) return;
  answered = true;
  
  if (animationId) cancelAnimationFrame(animationId);
  if (timerInterval) clearInterval(timerInterval);
  
  var userAns = parseInt(currentAnswer);
  if (userAns === correctAnswer) {
    score++;
    correctSound();
    if (problemEl) problemEl.style.background = '#95E1D3';
  } else {
    lives--;
    wrongSound();
    if (problemEl) problemEl.style.background = '#F38181';
  }
  
  updateUI();
  question++;
  
  setTimeout(nextQuestion, 500);
}

function updateUI() {
  document.getElementById('score').textContent = score;
  var h = '';
  for (var i = 0; i < lives; i++) h += '‚ù§Ô∏è';
  for (var i = lives; i < maxLives; i++) h += 'üñ§';
  document.getElementById('lives').innerHTML = h;
}

function endGame() {
  console.log('endGame called');
  gameActive = false;
  if (animationId) cancelAnimationFrame(animationId);
  if (timerInterval) clearInterval(timerInterval);
  if (problemEl) problemEl.remove();
  
  gameTotalTime = Math.floor((Date.now() - gameStartTime) / 1000);
  
  document.getElementById('finalscore').textContent = score;
  document.getElementById('finaltime').textContent = gameTotalTime;
  var msg = score === 10 ? 'Perfect! üåü' : score >= 7 ? 'Great job! üëè' : 'Keep practicing! üí™';
  document.getElementById('message').textContent = msg;
  
  if (checkHighScore(score, gameTotalTime)) {
    document.getElementById('name-entry').style.display = 'block';
  } else {
    document.getElementById('name-entry').style.display = 'none';
  }
  
  document.getElementById('game').classList.remove('active');
  document.getElementById('gameover').classList.add('active');
  console.log('Game over screen should be visible now');
}

function getLeaderboardKey() {
  return 'mathdrop_lb_' + gameType + '_' + gameLevel + '_' + difficulty;
}

function checkHighScore(newScore, newTime) {
  var key = getLeaderboardKey();
  var lb = JSON.parse(localStorage.getItem(key) || '[]');
  
  if (lb.length < 10) return true;
  
  lb.sort(function(a, b) {
    if (b.score !== a.score) return b.score - a.score;
    return a.time - b.time;
  });
  
  var worst = lb[9];
  return newScore > worst.score || (newScore === worst.score && newTime < worst.time);
}

function saveAndContinue() {
  var nameInput = document.getElementById('playername');
  if (nameInput.value.trim() && document.getElementById('name-entry').style.display !== 'none') {
    saveScore(nameInput.value.trim());
    nameInput.value = '';
  }
  document.getElementById('gameover').classList.remove('active');
  showLeaderboard();
}

function saveScore(name) {
  var key = getLeaderboardKey();
  var lb = JSON.parse(localStorage.getItem(key) || '[]');
  
  lb.push({
    name: name,
    score: score,
    time: gameTotalTime,
    date: Date.now()
  });
  
  lb.sort(function(a, b) {
    if (b.score !== a.score) return b.score - a.score;
    return a.time - b.time;
  });
  
  lb = lb.slice(0, 10);
  localStorage.setItem(key, JSON.stringify(lb));
}

function showLeaderboard() {
  var content = '';
  var types = [
    {type: 'addition', levels: [20, 30]},
    {type: 'tables', levels: [2, 3, 4, 5, 6, 7, 8, 9, 10]}
  ];
  var diffs = ['easy', 'medium', 'hard'];
  
  types.forEach(function(t) {
    t.levels.forEach(function(level) {
      diffs.forEach(function(diff) {
        var key = 'mathdrop_lb_' + t.type + '_' + level + '_' + diff;
        var lb = JSON.parse(localStorage.getItem(key) || '[]');
        
        if (lb.length > 0) {
          var title = t.type === 'addition' ? 'Addition ‚â§' + level : level + '√ó Table';
          title += ' (' + diff.charAt(0).toUpperCase() + diff.slice(1) + ')';
          
          content += '<h3 style="margin-top:20px; color:white;">' + title + '</h3>';
          content += '<div class="lb-table"><table>';
          content += '<tr><th>#</th><th>Name</th><th>Score</th><th>Time</th></tr>';
          
          lb.forEach(function(entry, i) {
            content += '<tr><td>' + (i+1) + '</td><td>' + entry.name + '</td><td>' + entry.score + '/10</td><td>' + entry.time + 's</td></tr>';
          });
          
          content += '</table></div>';
        }
      });
    });
  });
  
  if (content === '') {
    content = '<p style="font-size:20px; margin:20px;">No scores yet! Be the first to play!</p>';
  }
  
  document.getElementById('lb-content').innerHTML = content;
  document.getElementById('home').classList.remove('active');
  document.getElementById('leaderboard').classList.add('active');
}

function closeLeaderboard() {
  document.getElementById('leaderboard').classList.remove('active');
  document.getElementById('home').classList.add('active');
}

function playAgain() {
  document.getElementById('gameover').classList.remove('active');
  startGameWithDifficulty(difficulty);
}

function goHome() {
  gameActive = false;
  if (animationId) cancelAnimationFrame(animationId);
  if (timerInterval) clearInterval(timerInterval);
  if (problemEl) problemEl.remove();
  document.getElementById('home').classList.add('active');
  document.getElementById('game').classList.remove('active');
  document.getElementById('gameover').classList.remove('active');
  document.getElementById('difficulty').classList.remove('active');
  document.getElementById('leaderboard').classList.remove('active');
}

console.log('Script fully loaded and ready!');
</script>

</body>
</html>